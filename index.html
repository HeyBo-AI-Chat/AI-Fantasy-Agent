<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Fantasy Agent</title>
  <meta name="theme-color" content="#0B132B" />
  <style>
    :root{--bg:#0B132B;--fg:#fff;--muted:#94a3b8;--card:#111827;--accent:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:480px;margin:0 auto;padding:16px}
    .section{max-width:480px;margin:0 auto;padding:12px 16px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:12px;margin:12px 0}
    .row{display:flex;gap:8px;align-items:center}
    .row.spread{justify-content:space-between}
    input,select,textarea,button{width:100%}
    input,select,textarea{background:#0f172a;color:#fff;border:1px solid #1f2937;border-radius:10px;padding:10px}
    textarea{min-height:100px}
    .btn{background:var(--accent);color:#000;border:none;border-radius:10px;padding:12px;font-weight:600;cursor:pointer}
    .btn.muted{background:#1f2937;color:#cbd5e1}
    .hidden{display:none!important}
    .badge{font-size:12px;color:#94a3b8}
    #tabs{position:sticky;bottom:0;left:0;right:0;background:rgba(11,19,43,.9);backdrop-filter:saturate(120%) blur(6px);
      border-top:1px solid #1f2937;padding:8px;display:flex;gap:8px;max-width:480px;margin:0 auto}
    .tabbtn{flex:1;padding:12px 10px;border-radius:10px;background:#111827;color:#cbd5e1;border:1px solid #1f2937}
    .tabbtn.active{background:var(--accent);color:#000;font-weight:700}
    a.card{display:block;color:inherit;text-decoration:none}
    @media (max-width:480px){.row{flex-wrap:wrap}}
  </style>
</head>
<body>
  <header class="section"><h1 style="margin:0;font-size:20px">AI Fantasy Agent</h1></header>

  <!-- Season / Week -->
  <section class="section">
    <div class="row">
      <select id="season" aria-label="Season"></select>
      <select id="week" aria-label="Week"></select>
    </div>
    <div style="margin-top:12px">
      <button id="btnCompute" type="button" class="btn">Compute</button>
    </div>
  </section>

  <!-- Sources -->
  <section class="section">
    <h2 style="margin:0 0 8px">Select Platform</h2>
    <select id="srcPlatform"></select>
    <input id="srcHandle" placeholder="Username / League ID" style="margin-top:8px" />
    <textarea id="srcNotes" placeholder="Notes (optional)" rows="3" style="margin-top:8px"></textarea>
    <div style="margin-top:12px">
      <button id="btnAddSource" type="button" class="btn">Add Source</button>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="row spread">
        <h3 style="margin:0">Linked Sources</h3>
        <button class="btn muted" id="reloadSources" type="button">Reload</button>
      </div>
      <div id="linkedSources" style="margin-top:10px"><i>None yet.</i></div>
    </div>
  </section>

  <!-- Draft -->
  <section id="tab-draft" class="section">
    <div class="row spread">
      <h2 style="margin:0">Draft</h2>
      <span class="badge"><span id="draftCount">0</span> players</span>
    </div>
    <div id="draftList"></div>
  </section>

  <!-- Roster -->
  <section id="tab-roster" class="section hidden">
    <div class="row spread">
      <h2 style="margin:0">Roster</h2>
      <span class="badge"><span id="rosterCount">0</span> players</span>
    </div>
    <div id="rosterList"><i>No roster yet.</i></div>
  </section>

  <!-- Lineup -->
  <section id="tab-lineup" class="section hidden">
    <h2>Lineup</h2>
    <div class="card"><b>Starters</b><div id="starters" style="margin-top:6px"></div></div>
    <div class="card"><b>Bench</b><div id="bench" style="margin-top:6px"></div></div>
  </section>

  <!-- Scores -->
  <section id="tab-scores" class="section hidden">
    <h2>Scores</h2>
    <div id="scoresList"></div>
  </section>

  <!-- News -->
  <section id="tab-news" class="section hidden">
    <h2>News</h2>
    <div id="newsList"></div>
  </section>

  <!-- Agent -->
  <section id="tab-agent" class="section hidden">
    <h2>Agent</h2>
    <textarea id="agentInput" placeholder="Ask the agentâ€¦" rows="3"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="btnAsk" type="button" class="btn">Ask</button>
      <button id="btnTTS" type="button" class="btn muted">ðŸ”ˆ Speak: Off</button>
    </div>
    <div id="agentReply" class="card" style="margin-top:12px"><i>Ask something to get started.</i></div>
  </section>

  <!-- Bottom nav -->
  <nav id="tabs">
    <button type="button" class="tabbtn active" data-t="draft">Draft</button>
    <button type="button" class="tabbtn" data-t="roster">Roster</button>
    <button type="button" class="tabbtn" data-t="lineup">Lineup</button>
    <button type="button" class="tabbtn" data-t="scores">Scores</button>
    <button type="button" class="tabbtn" data-t="news">News</button>
    <button type="button" class="tabbtn" data-t="agent">Agent</button>
  </nav>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <!-- App (inline to keep it truly one file) -->
  <script>
  // ======== Config (your real project values) ========
  var APP = {
  SUPABASE_URL: "https://dcsxzyglwddqvqnuukzj.supabase.co",
  SUPABASE_ANON: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjc3h6eWdsd2RkcXZxbnV1a3pqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MzQ0NTIsImV4cCI6MjA3MTIxMDQ1Mn0.WExhpsLwWZqtsLt5-zZS2tUihSaD-TFk7TkJmCzaLIs",

  FUNCS: "https://dcsxzyglwddqvqnuukzj.functions.supabase.co",

  // âœ… real ids (UUIDs)
  TEAM_ID: "a9d45759-2edc-4d1d-a66c-8af2147a373b",
  // LEAGUE_ID is not used by the UI code you pasted, so it can be omitted or left as-is.

  SEASON_DEFAULT: 2024,
  WEEK_DEFAULT: 1,

  OPENROUTER_PROVIDER: "openrouter"
};

  // ======== Supabase client (Safari-safe) ========
  var supaCreate = (window.supabase && window.supabase.createClient) || window.createClient;
  if (!supaCreate) console.warn('Supabase library not found.');
  var supabase = window._supabaseClient || (
    window._supabaseClient = (supaCreate ? supaCreate(APP.SUPABASE_URL, APP.SUPABASE_ANON) : null)
  );

  // ======== Small helpers ========
  function $id(id){ return document.getElementById(id); }
  function $$(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function qs(p){ var a=[]; for (var k in p){ a.push(encodeURIComponent(k)+'='+encodeURIComponent(p[k])); } return a.join('&'); }
  var hdrs = { 'Content-Type':'application/json', 'apikey':APP.SUPABASE_ANON, 'Authorization':'Bearer '+APP.SUPABASE_ANON };

  // Dev-only user id (no Auth)
  async function getUserId(){
    try{
      var id = localStorage.getItem('dev_user_id');
      if(!id){
        if (crypto && crypto.randomUUID) id = crypto.randomUUID();
        else id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});
        localStorage.setItem('dev_user_id', id);
      }
      return id;
    }catch(e){ return 'dev-user-1'; }
  }

  // ======== Dropdowns ========
  var seasonSel, weekSel;
  function fillSelect(sel, items, placeholder){
    if(!sel) return;
    var html = '<option value="">' + (placeholder||'Selectâ€¦') + '</option>';
    for (var i=0;i<items.length;i++){ html += '<option value="'+items[i]+'">'+items[i]+'</option>'; }
    sel.innerHTML = html;
  }
  function getSelectedWeek(){
    var raw = (weekSel && weekSel.value || '').trim();
    var n = Number(raw);
    if (!raw) return {type:'regular', value:APP.WEEK_DEFAULT||1};
    if (!isNaN(n) && n>=1 && n<=18) return {type:'regular', value:n};
    return {type:'playoff', value:raw}; // 'WC'|'DIV'|'CONF'|'SB'
    }
  function initDropdowns(){
    seasonSel = $id('season');
    weekSel   = $id('week');
    fillSelect(seasonSel, [2024,2023,2022,2021,2020], 'Select Season');

    if (weekSel){
      var html = '<option value="">Select Week / Round</option>';
      html += '<optgroup label="Regular Season">';
      for (var w=1; w<=18; w++){ html += '<option value="'+w+'">Week '+w+'</option>'; }
      html += '</optgroup>';
      html += '<optgroup label="Playoffs">';
      var po=[['WC','Wild Card'],['DIV','Divisional'],['CONF','Conference Championship'],['SB','Super Bowl']];
      for (var i=0;i<po.length;i++){ html += '<option value="'+po[i][0]+'">'+po[i][1]+'</option>'; }
      html += '</optgroup>';
      weekSel.innerHTML = html;
    }

    fillSelect($id('srcPlatform'),
      ['DraftKings','FanDuel','Yahoo','ESPN','Sleeper','Other'],
      'Select Platform'
    );

    // Defaults in UI
    if (seasonSel) seasonSel.value = String(APP.SEASON_DEFAULT||new Date().getFullYear());
    if (weekSel)   weekSel.value   = String(APP.WEEK_DEFAULT||1);
  }

  // ======== Tabs ========
  function initTabs(){
    var sections = {
      draft:  $id('tab-draft'),
      roster: $id('tab-roster'),
      lineup: $id('tab-lineup'),
      scores: $id('tab-scores'),
      news:   $id('tab-news'),
      agent:  $id('tab-agent')
    };
    function showTab(name){
      for (var k in sections){ if(sections[k]) sections[k].classList.toggle('hidden', k!==name); }
      $$('.tabbtn').forEach(function(b){ b.classList.toggle('active', b.getAttribute('data-t')===name); });
      localStorage.setItem('active_tab', name);
      if (name==='roster') loadSources();
      if (name==='scores') loadScores();
    }
    $$('.tabbtn').forEach(function(b){ b.addEventListener('click', function(){ showTab(b.getAttribute('data-t')); }); });
    showTab(localStorage.getItem('active_tab') || 'draft');
  }

  // ======== Sources (per user) ========
  async function loadSources(){
    var box = $id('linkedSources'); if(!box) return;
    box.innerHTML = 'Loadingâ€¦';
    var user_id = await getUserId();
    var res = await supabase.from('team_sources').select('*').eq('user_id', user_id).order('created_at', {ascending:false});
    if (res.error){ box.innerHTML = '<div class="badge" style="color:#ff6b6b">Error: '+res.error.message+'</div>'; return; }
    var data = res.data || [];
    if (!data.length){ box.innerHTML = '<i>No saved platforms yet.</i>'; return; }
    var html = '';
    data.forEach(function(r){
      html += '<div class="row" style="justify-content:space-between;align-items:center;margin:.5rem 0;">'
           +  '<div><b>'+r.platform+'</b> â€” '+r.handle+(r.notes?'<div class="badge" style="opacity:.8">'+r.notes+'</div>':'')+'</div>'
           +  '<button class="btn muted" data-del="'+r.id+'">Delete</button>'
           +  '</div>';
    });
    box.innerHTML = html;

    // hook delete buttons (fixed: no stray code!)
    $$('#linkedSources [data-del]').forEach(function(btn){
      btn.addEventListener('click', async function(){
        var id = btn.getAttribute('data-del');
        var del = await supabase.from('team_sources').delete().eq('id', id);
        if (del.error) alert('Delete failed: '+del.error.message);
        else loadSources();
      });
    });
  }

  async function addSource(){
    var platform = ($id('srcPlatform') && $id('srcPlatform').value || '').trim();
    var handle   = ($id('srcHandle') && $id('srcHandle').value || '').trim();
    var notes    = ($id('srcNotes')  && $id('srcNotes').value  || '').trim();
    if (!platform || !handle){ alert('Platform and Handle / League ID are required'); return; }
    var user_id = await getUserId();
    var team_id = APP.TEAM_ID || 'demo-team-1';

    var ins = await supabase.from('team_sources').insert([{ user_id:user_id, team_id:team_id, platform:platform, handle:handle, notes:notes }]).select();
    if (ins.error){ alert('Save failed: '+ins.error.message); return; }
    if ($id('srcHandle')) $id('srcHandle').value = '';
    if ($id('srcNotes'))  $id('srcNotes').value  = '';
    loadSources();
  }

  // ======== Data fetchers (safe fallbacks) ========
  async function getJSON(url){ try{ var r = await fetch(url,{headers:hdrs}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }catch(_){ return []; } }

  async function loadDraft(){
    var season = Number(seasonSel && seasonSel.value || new Date().getFullYear());
    var wk = getSelectedWeek();
    if (wk.type!=='regular'){ $id('draftList').innerHTML = '<div class="badge">Draft list not available for playoff rounds.</div>'; $id('draftCount').textContent='0'; return; }
    var url = APP.SUPABASE_URL+'/rest/v1/weekly_stats?'+qs({
      select:"player_id,position,team_id,season,week,fantasy_ppr,players(player_name)",
      sport:"eq:nfl",season:"eq:"+season,week:"eq:"+wk.value,order:"fantasy_ppr.desc",limit:200
    });
    var data = await getJSON(url);
    $id('draftCount').textContent = data.length;
    $id('draftList').innerHTML = data.map(function(row){
      return '<div class="card"><div class="row spread">'
        + '<div><div><b>'+(row.players&&row.players.player_name||row.player_id)+'</b></div>'
        + '<div class="badge">'+(row.team_id||'')+' Â· '+(row.position||'')+'</div></div>'
        + '<div style="text-align:right"><div><b>'+Number(row.fantasy_ppr||0).toFixed(2)+'</b> PPR</div>'
        + '<button class="btn muted" data-add="'+row.player_id+'">Add</button></div>'
        + '</div></div>';
    }).join('');
  }

  async function loadScores(){
    var season = Number(seasonSel && seasonSel.value || new Date().getFullYear());
    var wk = getSelectedWeek();
    var params = { select:"team_id,season,week,points,breakdown", season:"eq:"+season };
    if (wk.type==='regular') params.week = "eq:"+wk.value;
    var url = APP.SUPABASE_URL+'/rest/v1/team_week_scores?'+qs(params);
    var data = await getJSON(url);
    var list = $id('scoresList');
    list.innerHTML = data.map(function(r){
      var bd = r.breakdown || {};
      var pieces = [];
      for (var k in bd){ pieces.push(k+': '+Number(bd[k]).toFixed(1)); if (pieces.length>=6) break; }
      return '<div class="card"><div class="row spread"><b>'+r.team_id+'</b><b>'+Number(r.points||0).toFixed(2)+'</b></div>'
           + '<div class="badge">'+pieces.join(' Â· ')+'</div></div>';
    }).join('');
  }

  async function loadNews(){
    var url = APP.SUPABASE_URL+'/rest/v1/news_items?'+qs({select:"published_at,source,title,url,impact_tag",order:"published_at.desc",limit:100});
    var data = await getJSON(url);
    var list = $id('newsList');
    list.innerHTML = data.map(function(n){
      return '<a class="card" href="'+n.url+'" target="_blank" rel="noopener">'
           + '<div><b>'+n.source+'</b> â€” <span class="badge">'+new Date(n.published_at).toLocaleString()+'</span></div>'
           + '<div>'+n.title+'</div><div class="badge">'+(n.impact_tag||'GENERAL')+'</div></a>';
    }).join('');
  }

  // ======== Compute button ========
  async function computeNow(){
    var season = Number(seasonSel && seasonSel.value || new Date().getFullYear());
    var wk = getSelectedWeek();
    var payload = { team_id: APP.TEAM_ID||'demo-team-1', season:season, week:(wk.type==='regular'?wk.value:null), round:(wk.type==='playoff'?wk.value:null) };
    if (!APP.FUNCS){ alert('Functions base URL missing.'); return; }
    try{
      var res = await fetch(APP.FUNCS+'/compute-scores', { method:'POST', headers:hdrs, body:JSON.stringify(payload) });
      var text = await res.text();
      if (!res.ok){ alert('Compute failed: '+res.status+' '+text); return; }
      alert('Compute finished: '+(text||res.status));
      loadScores();
    }catch(e){ alert('Compute failed: '+(e && e.message || e)); }
  }

  // ======== Agent (optional) ========
  var TTS_ENABLED=false;
  function speak(text){ try{ if(!TTS_ENABLED || !("speechSynthesis" in window)) return; var u=new SpeechSynthesisUtterance(text); u.lang="en-US"; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);}catch(e){} }
  $id('btnTTS').addEventListener('click', function(){ TTS_ENABLED=!TTS_ENABLED; this.textContent = TTS_ENABLED ? "ðŸ”Š Speak: On" : "ðŸ”ˆ Speak: Off"; if(TTS_ENABLED) speak("Speech enabled."); });
  $id('btnAsk').addEventListener('click', async function(){
    var msg = ($id('agentInput') && $id('agentInput').value || '').trim(); if(!msg) return;
    var thinking = "Thinkingâ€¦"; $id('agentReply').textContent = thinking; speak(thinking);
    try{
      var wk = getSelectedWeek();
      var r = await fetch(`${APP.FUNCS}/agent`, {   // was /agent_router
  method: 'POST',
  headers: hdrs,
  body: JSON.stringify({ message: msg, sport:'nfl', season, week, round, task:'reason' })
});
      var res = {}; try { res = await r.json(); } catch(_){}
      var reply = res.reply || res.message || res.text || "No reply.";
      $id('agentReply').textContent = reply; speak(reply);
    }catch(_){ $id('agentReply').textContent = 'Error contacting agent.'; }
  });

  // ======== Buttons & boot ========
  function bindButtons(){
    $id('btnAddSource').addEventListener('click', function(e){ e.preventDefault(); addSource(); });
    $id('reloadSources').addEventListener('click', function(){ loadSources(); });
    $id('btnCompute').addEventListener('click', function(e){ e.preventDefault(); computeNow(); });
  }

  document.addEventListener('DOMContentLoaded', async function(){
    initDropdowns();
    initTabs();
    bindButtons();

    loadDraft();
    loadSources();
    loadScores();
    loadNews();

    if (seasonSel) seasonSel.addEventListener('change', function(){ loadDraft(); loadScores(); });
    if (weekSel)   weekSel.addEventListener('change',   function(){ loadDraft(); loadScores(); });

    // Realtime updates (optional)
    try{
      supabase.channel('fantasy-realtime')
        .on('postgres_changes', { event:'*', schema:'public', table:'fantasy_points' }, function(){ loadScores(); })
        .subscribe();
    }catch(_){}
  });
  </script>
</body>
</html>
